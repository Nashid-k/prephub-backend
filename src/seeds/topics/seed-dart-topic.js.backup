import mongoose from 'mongoose';
import dotenv from 'dotenv';
import Topic from '../../models/Topic.js';
import Category from '../../models/Category.js';
import Section from '../../models/Section.js';
import path from 'path';
import { fileURLToPath } from 'url';
import { assignGroup } from '../utils/categoryGrouping.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

dotenv.config({ path: path.join(__dirname, '../../../.env') });

const dartData = {
  "Dart_Fundamentals": {
    "01_introduction": {
      "core_concepts": [
        "Dart - Client-optimized Language for Multi-platform Development",
        "Dart in Flutter Ecosystem",
        "JIT (Just-In-Time) vs AOT (Ahead-Of-Time) Compilation",
        "Dart vs JavaScript/TypeScript Comparison"
      ],
      "development_environment": [
        "Dart SDK Installation",
        "DartPad Online Editor",
        "IDE Setup (VS Code, IntelliJ)",
        "Running Dart Programs"
      ]
    },

    "02_basic_syntax": {
      "program_structure": [
        "Main Function Entry Point",
        "Import Statements",
        "Comments (Single-line //, Multi-line /* */)",
        "Dart File Structure"
      ]
    }
  },

  "Variables_Data_Types": {
    "01_basic_types": [
      "int - Integer Numbers",
      "double - Floating-point Numbers",
      "num - Parent Type for int and double",
      "String - Text Data",
      "bool - Boolean Values",
      "Null Type"
    ],

    "02_type_system": [
      "Type Inference (var keyword)",
      "Type Safety and Sound Null Safety",
      "Type Checking (is, is! operators)",
      "Type Casting (as operator)",
      "Type Promotion"
    ],

    "03_variable_declaration": [
      "var for Type Inference",
      "final for Runtime Constants",
      "const for Compile-time Constants",
      "late for Deferred Initialization",
      "Choosing Between var, final, const"
    ]
  },

  "Operators": {
    "arithmetic": [
      "Basic Arithmetic (+, -, *, /)",
      "Integer Division (~/)",
      "Modulo (%)",
      "Increment/Decrement (++, --)"
    ],

    "comparison": [
      "Equality Operators (==, !=)",
      "Relational Operators (>, <, >=, <=)"
    ],

    "logical": [
      "Logical AND (&&)",
      "Logical OR (||)",
      "Logical NOT (!)"
    ],

    "null_aware": [
      "Null-aware Operator (??)",
      "Null-aware Assignment (??=)",
      "Null-aware Access (?.)",
      "Null-aware Cascade (?..)"
    ],

    "other_operators": [
      "Cascade Operator (..) for Method Chaining",
      "Spread Operator (...) for Collections",
      "Conditional (Ternary) Operator (?:)",
      "Type Test Operators (is, is!, as)"
    ]
  },

  "Control_Flow": {
    "conditionals": [
      "if-else Statements",
      "Switch-case Statements",
      "Switch Expressions",
      "Conditional Expressions"
    ],

    "loops": [
      "for Loop (Traditional)",
      "for-in Loop (Collection Iteration)",
      "while Loop",
      "do-while Loop",
      "Loop Control (break, continue)"
    ]
  },

  "Functions": {
    "01_function_basics": [
      "Function Declaration Syntax",
      "Parameters and Arguments",
      "Return Types (void, explicit types)",
      "Function Scope"
    ],

    "02_parameter_types": [
      "Required Positional Parameters",
      "Optional Positional Parameters ([] syntax)",
      "Named Parameters ({} syntax)",
      "Required Named Parameters (required keyword)",
      "Default Parameter Values"
    ],

    "03_function_types": [
      "Anonymous Functions",
      "Arrow Functions (=> syntax)",
      "Higher-order Functions",
      "Closures",
      "Recursive Functions"
    ]
  },

  "Collections": {
    "01_lists": [
      "List Creation (List literal, List constructor)",
      "Fixed-length vs Growable Lists",
      "List Operations (add, remove, insert)",
      "List Properties (length, isEmpty, first, last)",
      "List Iteration Methods"
    ],

    "02_sets": [
      "Set Creation (Set literal)",
      "Unique Element Guarantee",
      "Set Operations (union, intersection, difference)",
      "Set vs List Use Cases"
    ],

    "03_maps": [
      "Map Creation (Map literal)",
      "Key-Value Pair Storage",
      "Accessing and Modifying Values",
      "Map Iteration (keys, values, entries)",
      "Map Methods (containsKey, remove)"
    ],

    "04_collection_operators": [
      "Spread Operator (...) for Expanding Collections",
      "Collection If for Conditional Elements",
      "Collection For for Generating Elements",
      "Null-aware Spread (...?)"
    ],

    "05_collection_methods": [
      "forEach() for Iteration",
      "map() for Transformation",
      "where() for Filtering",
      "reduce() and fold() for Aggregation",
      "any() and every() for Condition Checking"
    ]
  },

  "Strings": {
    "string_basics": [
      "String Literals (Single vs Double Quotes)",
      "String Interpolation (\${expression})",
      "Multi-line Strings (Triple Quotes)",
      "Raw Strings (r prefix)"
    ],

    "string_methods": [
      "Length and Empty Checks",
      "Case Conversion (toUpperCase, toLowerCase)",
      "Trimming (trim, trimLeft, trimRight)",
      "Substring and Character Access",
      "Searching (contains, indexOf, lastIndexOf)",
      "Splitting and Joining (split, join)"
    ]
  },

  "Object_Oriented_Programming": {
    "01_classes_objects": [
      "Class Definition Syntax",
      "Object Creation (new keyword optional)",
      "Instance Variables (Fields)",
      "Constructors (Default, Parameterized)"
    ],

    "02_constructors": [
      "Named Constructors",
      "Factory Constructors",
      "Constant Constructors (const)",
      "Redirecting Constructors",
      "Private Constructors"
    ],

    "03_inheritance": [
      "extends Keyword for Inheritance",
      "Method Overriding (@override)",
      "super Keyword (Accessing Parent)",
      "Single Inheritance in Dart"
    ],

    "04_interfaces": [
      "Implicit Interfaces",
      "implements Keyword",
      "Multiple Interface Implementation",
      "Interface vs Abstract Class"
    ],

    "05_abstract_classes": [
      "Abstract Class Definition",
      "Abstract Methods",
      "Concrete Implementation in Subclasses"
    ],

    "06_mixins": [
      "Mixin Definition (mixin keyword)",
      "with Keyword for Mixin Application",
      "Mixin Constraints (on keyword)",
      "Multiple Mixins"
    ],

    "07_advanced_oop": [
      "Static Members (Variables and Methods)",
      "Getter and Setter Methods",
      "Private Members (_ prefix)",
      "Extension Methods"
    ]
  },

  "Exception_Handling": {
    "exception_basics": [
      "Exception vs Error Difference",
      "Built-in Exception Types",
      "try-catch Block",
      "Multiple catch Blocks"
    ],

    "exception_operations": [
      "finally Block for Cleanup",
      "rethrowing Exceptions",
      "Custom Exception Classes",
      "Error Handling Best Practices"
    ]
  },

  "Asynchronous_Programming": {
    "01_futures": [
      "Future Type (Asynchronous Operations)",
      "async and await Keywords",
      "Future.then() for Chaining",
      "Error Handling with Future.catchError()"
    ],

    "02_async_patterns": [
      "Future.delayed() for Timed Operations",
      "Multiple Future Execution",
      "Future.wait() for Parallel Operations",
      "Async Error Handling Patterns"
    ],

    "03_streams": [
      "Stream Type (Sequence of Events)",
      "Single-subscription vs Broadcast Streams",
      "Stream Listeners",
      "Stream Controllers"
    ],

    "04_generators": [
      "Synchronous Generator (sync*)",
      "Asynchronous Generator (async*)",
      "yield Keyword for Value Emission",
      "Generator Use Cases"
    ]
  },

  "Generics": {
    "generics_basics": [
      "Generic Type Parameters (<T>)",
      "Generic Classes",
      "Generic Methods",
      "Type Constraints (extends keyword)"
    ],

    "generic_collections": [
      "List<T> for Type-safe Lists",
      "Set<T> for Type-safe Sets",
      "Map<K, V> for Type-safe Maps",
      "Generic Function Types"
    ]
  },

  "Null_Safety": {
    "null_safety_basics": [
      "Sound Null Safety Principles",
      "Nullable Types (Type?)",
      "Non-nullable Types",
      "Null-aware Operators Usage"
    ],

    "migration_patterns": [
      "Handling Legacy Code",
      "Null Assertion Operator (!)",
      "late Keyword for Non-nullable Variables",
      "Null Safety Best Practices"
    ]
  },

  "Enums": {
    "enum_basics": [
      "Enum Definition",
      "Enum Values Access",
      "Switch with Enums",
      "Enhanced Enums (Methods and Properties)"
    ]
  },

  "File_IO": {
    "file_operations": [
      "dart:io Package Import",
      "File Reading (readAsString, readAsLines)",
      "File Writing (writeAsString)",
      "File and Directory Operations"
    ],

    "json_handling": [
      "dart:convert Package",
      "JSON Encoding (jsonEncode)",
      "JSON Decoding (jsonDecode)",
      "Model Classes with fromJson/toJson"
    ]
  },

  "Practical_Skills": {
    "01_common_patterns": [
      "Singleton Pattern Implementation",
      "Factory Pattern Usage",
      "Builder Pattern for Complex Objects",
      "Repository Pattern"
    ],

    "02_data_processing": [
      "List Transformations with map()",
      "Data Filtering with where()",
      "Data Aggregation with reduce()/fold()",
      "Sorting Collections"
    ],

    "03_error_handling": [
      "Robust Input Validation",
      "Graceful Error Recovery",
      "Logging and Debugging",
      "Unit Testing Basics"
    ]
  },

  "Essential_Projects": {
    "learning_projects": [
      "Console Calculator",
      "Todo List Application",
      "File Processor (Read/Write/Transform)",
      "API Client with HTTP Requests",
      "Data Analysis Tool"
    ],

    "must_implement_features": [
      "CRUD Operations with Collections",
      "File I/O Operations",
      "Error Handling Implementation",
      "Asynchronous Operations",
      "Data Validation"
    ]
  },

  "Best_Practices": {
    "01_code_quality": [
      "Effective Naming Conventions",
      "Code Organization (Separation of Concerns)",
      "Commenting and Documentation",
      "Consistent Code Style"
    ],

    "02_performance": [
      "Efficient Collection Usage",
      "Memory Management Considerations",
      "Asynchronous Operation Optimization",
      "Avoiding Common Pitfalls"
    ],

    "03_testing": [
      "Unit Test Writing Basics",
      "Test-driven Development Concepts",
      "Mocking Dependencies",
      "Test Coverage Awareness"
    ]
  },

  "Interview_Preparation": {
    "core_concepts": [
      "Null Safety Implementation",
      "Asynchronous Programming Patterns",
      "OOP Principles in Dart",
      "Collection Operations",
      "Error Handling Strategies"
    ],

    "practical_skills": [
      "Implement Common Data Structures",
      "Write Asynchronous Code",
      "Handle File I/O Operations",
      "Parse and Process JSON Data",
      "Debug Dart Applications"
    ]
  }
};

const formatName = (str) => {
    return str
        .replace(/^\\d+_/, '')
        .split('_')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
};

const seedDart = async () => {
    try {
        await mongoose.connect(process.env.MONGODB_URI);
        console.log('Connected to MongoDB');

        let topic = await Topic.findOne({ slug: 'dart' });
        if (!topic) {
            console.log('Creating Dart topic...');
            topic = await Topic.create({
                name: 'Dart',
                slug: 'dart',
                description: 'Master Dart for Flutter development',
                icon: 'ðŸŽ¯',
                order: 14,
                color: '#0175C2'
            });
        }

        const categoriesToDelete = await Category.find({ topicId: topic._id });
        const categoryIds = categoriesToDelete.map(c => c._id);
        if (categoryIds.length > 0) {
            await Section.deleteMany({ topicId: topic._id });
            await Category.deleteMany({ topicId: topic._id });
            console.log('Cleared existing Dart data');
        }

        const seenSlugs = new Set();
        const generateUniqueSlug = (title) => {
            let baseSlug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
            let slug = baseSlug;
            let counter = 1;
            while (seenSlugs.has(slug)) {
                counter++;
                slug = `${baseSlug}-${counter}`;
            }
            seenSlugs.add(slug);
            return slug;
        };

        let order = 1;
        for (const [mainKey, mainValue] of Object.entries(dartData)) {
            const groupName = formatName(mainKey); // Use mainKey as group - maintains study order!
            
            for (const [key, value] of Object.entries(mainValue)) {
                const categoryName = formatName(key);
                const categorySlug = generateUniqueSlug(categoryName);

                const category = await Category.create({
                    name: categoryName,
                    slug: categorySlug,
                    description: `Learn about ${categoryName}`,
                    topicId: topic._id,
                    group: groupName, // Direct from seed structure!
                    order: order++
                });

                let sections = [];
                if (Array.isArray(value)) {
                    sections = value;
                } else {
                    for (const [subKey, subItems] of Object.entries(value)) {
                        sections = [...sections, ...subItems];
                    }
                }

                const sectionDocs = sections.map((sectionTitle, index) => ({
                    title: sectionTitle,
                    slug: generateUniqueSlug(sectionTitle),
                    description: `Detailed explanation of ${sectionTitle}`,
                    content: 'Coming soon...',
                    categoryId: category._id,
                    topicId: topic._id,
                    order: index + 1,
                    difficulty: categoryName.includes('Advanced') || categoryName.includes('Asynchronous') ? 'advanced' : 
                               categoryName.includes('Introduction') || categoryName.includes('Fundamentals') || categoryName.includes('Basic') ? 'beginner' : 'intermediate',
                    estimatedTime: 15
                }));

                await Section.insertMany(sectionDocs);
                console.log(`Created Category: ${categoryName} (Group: ${formatName(mainKey)}) with ${sectionDocs.length} sections`);
            }
        }

        console.log('âœ… Dart seeding complete!');
        process.exit(0);
    } catch (error) {
        console.error('Error seeding data:', error);
        process.exit(1);
    }
};

seedDart();
